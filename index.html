<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Content Gap Analyzer - KI-optimierte Inhaltsanalyse</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f9fafb;
            --white: #ffffff;
            --border: #e5e7eb;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(180deg, #f0f2ff 0%, #ffffff 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: var(--dark);
            margin-bottom: 40px;
            animation: fadeIn 0.5s ease-out;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--gray);
        }

        .main-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: 40px;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.6s ease-out;
            margin-bottom: 30px;
        }

        .input-section {
            margin-bottom: 40px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .input-group label .required {
            color: var(--danger);
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .api-key-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.1));
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 25px;
        }

        .api-key-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .api-key-header h3 {
            color: var(--primary-dark);
            font-size: 1.1rem;
        }

        .api-key-info {
            background: var(--white);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .api-key-info p {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .api-key-info a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .api-key-info a:hover {
            text-decoration: underline;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: var(--light);
            border-radius: var(--radius);
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-weight: 500;
            color: var(--dark);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .loading-container {
            text-align: center;
            padding: 60px 20px;
            animation: fadeIn 0.3s ease-out;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 0 auto 25px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 25px;
        }

        .progress-bar {
            max-width: 400px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin: 0 auto;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .tab:hover {
            color: var(--dark);
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .summary-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.1));
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 30px;
        }

        .summary-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .citation-score-display {
            text-align: center;
            padding: 20px;
            background: var(--white);
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            position: relative;
        }

        .score-circle svg {
            transform: rotate(-90deg);
        }

        .score-circle-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: 8;
        }

        .score-circle-fill {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease;
        }

        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 700;
        }

        .optimization-tips {
            background: var(--light);
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 20px;
        }

        .optimization-tips h4 {
            color: var(--dark);
            margin-bottom: 15px;
        }

        .optimization-tips ul {
            list-style: none;
            padding: 0;
        }

        .optimization-tips li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            color: var(--gray);
        }

        .optimization-tips li:before {
            content: '✔';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
        }

        .fan-out-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .fan-out-card {
            background: var(--light);
            padding: 20px;
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .fan-out-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .fan-out-card h4 {
            color: var(--dark);
            font-size: 1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fan-out-queries {
            list-style: none;
        }

        .fan-out-query-item {
            padding: 12px;
            margin-bottom: 10px;
            background: var(--white);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .fan-out-query-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .query-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .query-text {
            color: var(--dark);
            font-size: 0.9rem;
            flex: 1;
            padding-left: 20px;
            position: relative;
        }

        .query-text:before {
            content: '→';
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        .query-score {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .query-score-high {
            background: #d4f4dd;
            color: #1e7e34;
        }

        .query-score-medium {
            background: #fff3cd;
            color: #856404;
        }

        .query-score-low {
            background: #f8d7da;
            color: #721c24;
        }

        .competitor-card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .competitor-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
        }

        .competitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .competitor-url {
            font-weight: 600;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .citation-score {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .score-high {
            background: #d4f4dd;
            color: #1e7e34;
        }

        .score-medium {
            background: #fff3cd;
            color: #856404;
        }

        .score-low {
            background: #f8d7da;
            color: #721c24;
        }

        .competitor-details {
            display: grid;
            gap: 10px;
        }

        .detail-row {
            display: flex;
            gap: 10px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--dark);
            min-width: 100px;
        }

        .detail-value {
            color: var(--gray);
            flex: 1;
        }

        .gap-card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .gap-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
        }

        .gap-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .gap-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .opportunity-score {
            display: flex;
            gap: 3px;
        }

        .star {
            width: 20px;
            height: 20px;
            background: var(--border);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }

        .star.filled {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
        }

        .gap-description {
            color: var(--gray);
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .gap-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .gap-meta-item {
            display: flex;
            flex-direction: column;
        }

        .gap-meta-label {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 3px;
        }

        .gap-meta-value {
            font-weight: 600;
            color: var(--dark);
        }

        .recommendation-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.1));
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
        }

        .recommendation-number {
            background: var(--primary);
            color: var(--white);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .recommendation-content h4 {
            font-size: 1.2rem;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .recommendation-content p {
            color: var(--gray);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .recommendation-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-tag {
            padding: 5px 12px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--dark);
        }

        .error-message {
            background: var(--danger);
            color: var(--white);
            padding: 15px 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .success-message {
            background: var(--success);
            color: var(--white);
            padding: 15px 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .potential-score-display {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .score-badge {
            text-align: center;
        }

        .score-badge-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .score-badge-label {
            font-size: 0.85rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-arrow {
            font-size: 1.5rem;
            color: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .position-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .position-high {
            background: #d4f4dd;
            color: #1e7e34;
        }

        .position-medium {
            background: #fff3cd;
            color: #856404;
        }

        .position-low {
            background: #f8d7da;
            color: #721c24;
        }

        .export-button {
            background: var(--success);
            color: var(--white);
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        @media print {
            body { background: white; }
            .tabs, .export-button { display: none !important; }
            .tab-content { display: block !important; page-break-after: always; }
            .main-card { box-shadow: none; }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .main-card {
                padding: 25px;
            }

            .button-group {
                flex-direction: column;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .fan-out-container {
                grid-template-columns: 1fr;
            }

            .gap-meta {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 AI Content Gap Analyzer</h1>
            <p>Website & Keyword Content-Gap Analysis mit Claude AI</p>
        </div>

        <div class="main-card">
            <div class="input-section" id="inputSection">
                <h2 style="margin-bottom: 25px;">Analyse-Parameter</h2>
                
                <div class="input-group">
                    <label for="keyword">
                        Haupt-Keyword / Suchanfrage <span class="required">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="keyword" 
                        placeholder="z.B. nachhaltige mode online shop"
                        autocomplete="off"
                    />
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="skipWebsite" onchange="toggleWebsiteInput()">
                    <label for="skipWebsite">
                        Ohne Website-Analyse durchführen (nur Content-Gap Analyse)
                    </label>
                </div>

                <div class="input-group" id="websiteGroup">
                    <label for="website">
                        Website URL zur Analyse
                    </label>
                    <input 
                        type="url" 
                        id="website" 
                        placeholder="https://example.com"
                        autocomplete="url"
                    />
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="startAnalysis()" id="analyzeBtn">
                        <span>🚀</span>
                        <span>Analyse starten</span>
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()">
                        <span>↻</span>
                        <span>Zurücksetzen</span>
                    </button>
                </div>
            </div>

            <div class="loading-container" id="loadingSection" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-text">Analyse läuft...</div>
                <div class="loading-subtext" id="loadingStatus">Initialisiere Claude AI...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <p style="margin-top: 20px; color: var(--gray); font-size: 0.9rem;">
                    Die Analyse kann 2–3 Minuten in Anspruch nehmen
                </p>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('summary')">Zusammenfassung</button>
                    <button class="tab" onclick="switchTab('fanout')">Query Fan-Out</button>
                    <button class="tab" onclick="switchTab('competitors')">Wettbewerber</button>
                    <button class="tab" onclick="switchTab('gaps')">Content Gaps</button>
                    <button class="tab" onclick="switchTab('recommendations')">Empfehlungen</button>
                    <button class="tab" onclick="switchTab('optimization')" id="optimizationTab" style="display: none;">Optimierung</button>
                </div>

                <!-- Summary Tab -->
                <div id="summaryTab" class="tab-content active">
                    <div class="summary-box">
                        <h3 class="summary-title">
                            <span>🎯</span>
                            Executive Summary
                        </h3>
                        <div id="summaryContent"></div>
                    </div>
                    <div style="display: flex; gap: 15px;">
                        <button class="export-button" onclick="exportResults()">
                            <span>📄</span>
                            <span>Ergebnisse als PDF exportieren</span>
                        </button>
                        <button class="export-button" style="background: var(--primary);" onclick="resetForm()">
                            <span>🔄</span>
                            <span>Neue Analyse</span>
                        </button>
                    </div>
                </div>

                <!-- Fan-Out Tab -->
                <div id="fanoutTab" class="tab-content">
                    <h3 style="margin-bottom: 20px;">🔍 Query Fan-Out Analyse</h3>
                    <p style="color: var(--gray); margin-bottom: 25px;">
                        Spezifische Sub-Queries, die Claude AI für Ihr Keyword generiert:
                    </p>
                    <div id="fanOutResults" class="fan-out-container"></div>
                </div>

                <!-- Competitors Tab -->
                <div id="competitorsTab" class="tab-content">
                    <h3 style="margin-bottom: 20px;">🏆 Wettbewerber-Analyse</h3>
                    <p style="color: var(--gray); margin-bottom: 25px;">
                        Detaillierte Citation Probability Scores und Analyse:
                    </p>
                    <div id="competitorResults"></div>
                </div>

                <!-- Content Gaps Tab -->
                <div id="gapsTab" class="tab-content">
                    <h3 style="margin-bottom: 20px;">📊 Content Gap Analyse</h3>
                    <p style="color: var(--gray); margin-bottom: 25px;">
                        Identifizierte Inhaltslücken mit Opportunity Assessment:
                    </p>
                    <div id="gapResults"></div>
                </div>

                <!-- Recommendations Tab -->
                <div id="recommendationsTab" class="tab-content">
                    <h3 style="margin-bottom: 20px;">💡 Strategische Empfehlungen</h3>
                    <p style="color: var(--gray); margin-bottom: 25px;">
                        Priorisierte Maßnahmen für maximale AI-Sichtbarkeit:
                    </p>
                    <div id="recommendationResults"></div>
                </div>

                <!-- Optimization Tab (nur ohne Website) -->
                <div id="optimizationTab" class="tab-content">
                    <h3 style="margin-bottom: 20px;">🚀 Content-Optimierungsempfehlungen</h3>
                    <p style="color: var(--gray); margin-bottom: 25px;">
                        Was eine Website braucht, um Citation Score 85+ zu erreichen:
                    </p>
                    <div id="optimizationResults"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let analysisResults = null;
        let progressInterval = null;
        let currentProgress = 0;
        
        // Backend server configuration - Vercel API Routes
        const BACKEND_URL = '/api'; // For Vercel deployment

        // Toggle website input based on checkbox
        function toggleWebsiteInput() {
            const skipCheckbox = document.getElementById('skipWebsite');
            const websiteGroup = document.getElementById('websiteGroup');
            const websiteInput = document.getElementById('website');
            const optimizationTab = document.querySelector('.tab[onclick*="optimization"]');
            
            if (skipCheckbox.checked) {
                websiteGroup.style.display = 'none';
                websiteInput.value = '';
                optimizationTab.style.display = 'block';
            } else {
                websiteGroup.style.display = 'block';
                optimizationTab.style.display = 'none';
            }
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Main analysis function
        async function startAnalysis() {
            const keyword = document.getElementById('keyword').value.trim();
            const website = document.getElementById('website').value.trim();
            const skipWebsite = document.getElementById('skipWebsite').checked;

            // Validation
            if (!keyword) {
                showError('Bitte geben Sie ein Keyword ein.');
                return;
            }

            if (!skipWebsite && !website) {
                showError('Bitte geben Sie eine Website URL ein oder wählen Sie "Ohne Website-Analyse".');
                return;
            }

            // Start analysis
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').classList.remove('active');

            // Start progress animation (60 seconds)
            startProgressAnimation();

            try {
                // Full analysis prompt based on project requirements
                const fullPrompt = buildFullAnalysisPrompt(keyword, website, skipWebsite);
                
                updateLoadingStatus('Claude AI führt umfassende Analyse durch...');
                const analysisResponse = await callClaudeAPI(fullPrompt.system, fullPrompt.user);
                
                if (!analysisResponse) {
                    throw new Error('Keine Antwort von Claude API erhalten');
                }

                updateLoadingStatus('Ergebnisse werden verarbeitet...');
                
                // Parse the comprehensive response
                const parsedResults = parseClaudeResponse(analysisResponse, keyword, website, skipWebsite);
                
                // Store results
                analysisResults = parsedResults;

                // Complete progress and show results
                completeProgress();
                
            } catch (error) {
                console.error('Analysis error:', error);
                stopProgressAnimation();
                showError('Ein Fehler ist aufgetreten: ' + error.message);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('inputSection').style.display = 'block';
            }
        }

        // Start progress animation
        function startProgressAnimation() {
            currentProgress = 0;
            const totalDuration = 60000; // 60 seconds
            const updateInterval = 100; // Update every 100ms
            const progressIncrement = (100 / (totalDuration / updateInterval));
            
            progressInterval = setInterval(() => {
                currentProgress = Math.min(currentProgress + progressIncrement, 95); // Max 95% during loading
                document.getElementById('progressBar').style.width = currentProgress + '%';
                
                // Update status messages based on progress
                if (currentProgress < 20) {
                    updateLoadingStatus('Initialisiere Claude AI...');
                } else if (currentProgress < 40) {
                    updateLoadingStatus('Analysiere Keyword und generiere Query Fan-Out...');
                } else if (currentProgress < 60) {
                    updateLoadingStatus('Identifiziere Content Gaps und Wettbewerber...');
                } else if (currentProgress < 80) {
                    updateLoadingStatus('Erstelle strategische Empfehlungen...');
                } else {
                    updateLoadingStatus('Finalisiere Analyse...');
                }
                
                // Stop at 95% if we reach 60 seconds
                if (currentProgress >= 95) {
                    clearInterval(progressInterval);
                }
            }, updateInterval);
        }

        // Stop progress animation
        function stopProgressAnimation() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        // Complete progress animation
        function completeProgress() {
            stopProgressAnimation();
            
            // Animate to 100%
            currentProgress = 100;
            document.getElementById('progressBar').style.width = '100%';
            updateLoadingStatus('Analyse abgeschlossen!');
            
            // Show results after short delay
            setTimeout(() => {
                displayResults();
            }, 500);
        }

        // Update loading status
        function updateLoadingStatus(status) {
            document.getElementById('loadingStatus').textContent = status;
        }

        // Build comprehensive analysis prompt
        function buildFullAnalysisPrompt(keyword, website, skipWebsite) {
            const systemPrompt = `Du bist ein Experte für SEO-Analyse und Content-Strategie mit tiefem Verständnis für Suchverhalten, Content-Qualitätsbewertung und Content-Gap-Identifizierung. 

WICHTIG: Alle Antworten und Analysen müssen auf Deutsch erfolgen.

Führe eine umfassende Analyse durch und strukturiere deine Antwort im JSON-Format für maschinelle Verarbeitung.`;

            let userPrompt = `Analysiere das Keyword "${keyword}"${!skipWebsite ? ` und die Website "${website}"` : ''}.

Erstelle eine vollständige Content-Gap-Analyse mit folgenden Komponenten:

${!skipWebsite ? `
### SCHRITT 1: Website Content Analyse für "${website}"
Bewerte:
- Content-Qualität (Tiefe, Genauigkeit, Vollständigkeit)
- Autoritätssignale (Expertise, Zitate, Datenquellen)
- Nutzerwert (Praktischer Nutzen, Umsetzbarkeit)
- Content-Struktur (Organisation, Lesbarkeit)
- Einzigartigkeit (Distinctive Insights)
- Aktualität

### SCHRITT 2: Wettbewerbslandschaft
Identifiziere die Top 5 Wettbewerber und bewerte deren Citation Probability Score.

### SCHRITT 3: Citation Probability für "${website}"
Bestimme einen Score (0-100) mit detaillierter Begründung.
` : `
### Content-Optimierungsempfehlungen
Beschreibe detailliert, welche Eigenschaften eine Website haben müsste, um einen Citation Score von 85+ zu erreichen:
- Authority Building Elemente
- Content-Tiefe Anforderungen  
- Unique Value Propositions
- Trust Signals
- Content-Struktur
- Vollständigkeitsfaktoren
- Praktische Elemente
- Aktualitätsanforderungen
`}

### SCHRITT 4: Query Fan-Out mit Citation Scores
Generiere 6-8 hochspezifische Kategorien von Sub-Queries für "${keyword}".
WICHTIG: Bewerte für JEDE einzelne Query den Citation Probability Score (0-100) basierend auf:
- Wie gut kann ${!skipWebsite ? `"${website}"` : 'eine optimierte Website'} diese spezifische Query beantworten?
- Wie wahrscheinlich ist es, dass Claude diese Seite für diese Query zitieren würde?
- Berücksichtige Content-Tiefe, Autorität und Relevanz für jede Query

### SCHRITT 5: Content Gap Identifikation
Analysiere systematisch diese Gap-Kategorien:
1. Praktische Entscheidungshilfen
2. Regionale/Lokale Informationen
3. Fortgeschrittenes Spezialwissen
4. Vergleichende Analysen
5. Prozess- und Rechtsberatung
6. Neue Trends und Technologien

### SCHRITT 6: Strategische Empfehlungen
Erstelle 5 priorisierte, konkrete Empfehlungen.

Antworte im folgenden JSON-Format:
{
    "summary": {
        "citationScore": ${!skipWebsite ? 'number' : 'null'},
        "topGaps": ["Gap 1", "Gap 2", "Gap 3"],
        "primaryRecommendation": "string",
        "potentialImpact": "string"
    },
    ${!skipWebsite ? `
    "websiteAnalysis": {
        "citationScore": number,
        "strengths": ["string"],
        "weaknesses": ["string"],
        "authoritySignals": ["string"],
        "improvement": "string"
    },
    "competitors": [
        {
            "url": "string",
            "citationScore": number,
            "strengths": ["string"],
            "weaknesses": ["string"],
            "authoritySignals": ["string"],
            "comparison": "string"
        }
    ],` : `
    "optimization": {
        "authorityElements": ["string"],
        "contentDepth": ["string"],
        "uniqueValue": ["string"],
        "trustSignals": ["string"],
        "structure": ["string"],
        "completeness": ["string"],
        "practical": ["string"],
        "currency": ["string"],
        "targetScore": "85+",
        "overallStrategy": "string"
    },`}
    "fanOut": {
        "categories": [
            {
                "name": "string",
                "icon": "emoji",
                "queries": [
                    {
                        "text": "Die spezifische Query",
                        "citationScore": number,
                        "reasoning": "Kurze Begründung für den Score"
                    }
                ]
            }
        ]
    },
    "gaps": [
        {
            "category": "string",
            "title": "string",
            "description": "string",
            "whyExists": "string",
            "contentType": "string",
            "opportunity": number,
            "difficulty": "string",
            "impact": "string",
            "searchVolume": "string"
        }
    ],
    "recommendations": [
        {
            "priority": number,
            "title": "string",
            "description": "string",
            "impact": "string",
            "actions": ["string"]
        }
    ]
}`;

            return { system: systemPrompt, user: userPrompt };
        }

        // Claude API call function - now calls your backend
        async function callClaudeAPI(systemPrompt, userPrompt) {
            try {
                const response = await fetch(`${BACKEND_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        systemPrompt: systemPrompt,
                        userPrompt: userPrompt
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Backend Error: ${errorData.error || response.status}`);
                }

                const data = await response.json();
                return data.response;
                
            } catch (error) {
                console.error('Backend API Error:', error);
                
                // Provide more helpful error messages
                if (error.message.includes('Failed to fetch')) {
                    throw new Error('Backend-Server nicht erreichbar. Bitte stellen Sie sicher, dass der Server läuft und die URL korrekt ist.');
                }
                throw error;
            }
        }

        // Parse Claude's response
        function parseClaudeResponse(response, keyword, website, skipWebsite) {
            try {
                // Try to extract JSON from the response
                let jsonMatch = response.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    
                    // Add competitor positions
                    if (parsed.competitors && Array.isArray(parsed.competitors)) {
                        // Sort competitors by citation score
                        const allCompetitors = [...parsed.competitors];
                        if (parsed.websiteAnalysis) {
                            allCompetitors.push({
                                url: website,
                                citationScore: parsed.websiteAnalysis.citationScore,
                                isAnalyzedSite: true
                            });
                        }
                        
                        // Sort and assign positions
                        allCompetitors.sort((a, b) => b.citationScore - a.citationScore);
                        allCompetitors.forEach((comp, index) => {
                            comp.position = index + 1;
                        });
                        
                        // Store position for analyzed website
                        if (parsed.websiteAnalysis) {
                            const analyzedSite = allCompetitors.find(c => c.isAnalyzedSite);
                            if (analyzedSite) {
                                parsed.websiteAnalysis.position = analyzedSite.position;
                            }
                        }
                        
                        // Update competitors with positions
                        parsed.competitors = allCompetitors.filter(c => !c.isAnalyzedSite);
                    }
                    
                    return parsed;
                }
            } catch (e) {
                console.error('Failed to parse JSON response:', e);
            }

            // If parsing fails, create structured fallback
            return createFallbackResults(keyword, website, skipWebsite);
        }

        // Create fallback results if API fails
        function createFallbackResults(keyword, website, skipWebsite) {
            // Generate realistic citation scores for queries
            const generateQueryScore = () => Math.floor(Math.random() * 60) + 20; // 20-80 range
            
            const result = {
                summary: {
                    citationScore: skipWebsite ? null : 65,
                    topGaps: [
                        `Interaktiver ${keyword} Konfigurator`,
                        `${keyword} ROI-Rechner mit Marktvergleich`,
                        `Regionale ${keyword} Anbieter-Datenbank`
                    ],
                    primaryRecommendation: `Entwicklung eines umfassenden ${keyword} Knowledge Centers`,
                    potentialImpact: "Citation Score Verbesserung um 30-50 Punkte möglich"
                },
                websiteAnalysis: skipWebsite ? null : {
                    citationScore: 65,
                    position: 4,
                    strengths: ["Grundlegende Informationen vorhanden", "Mobile-optimiert", "SSL-gesichert"],
                    weaknesses: ["Fehlende Tiefe", "Keine Expertenmeinungen", "Veraltete Daten"],
                    authoritySignals: ["Impressum vorhanden", "Datenschutzerklärung"],
                    improvement: "Mehr Datenquellen, Case Studies und Experteninterviews integrieren"
                },
                optimization: skipWebsite ? {
                    authorityElements: [
                        "Autor-Profile mit nachweisbarer Expertise",
                        "Zertifizierungen und Akkreditierungen prominent anzeigen",
                        "Peer-Reviews und Expertenbeiträge"
                    ],
                    contentDepth: [
                        "Mindestens 3000+ Wörter pro Hauptthema",
                        "Detaillierte technische Spezifikationen",
                        "Schritt-für-Schritt Anleitungen mit Screenshots"
                    ],
                    uniqueValue: [
                        "Eigene Primärforschung und Datenerhebung",
                        "Exklusive Experteninterviews",
                        "Proprietäre Tools und Rechner"
                    ],
                    trustSignals: [
                        "Wissenschaftliche Quellenangaben",
                        "Aktuelle Statistiken mit Quellennachweis",
                        "Verifizierte Kundenbewertungen"
                    ],
                    structure: [
                        "Klare Hierarchie mit H1-H6 Tags",
                        "Inhaltsverzeichnis mit Sprungmarken",
                        "FAQ-Schema-Markup"
                    ],
                    completeness: [
                        "Alle Aspekte des Themas abdecken",
                        "Verschiedene Nutzer-Personas ansprechen",
                        "Von Anfänger bis Experte"
                    ],
                    practical: [
                        "Downloadbare Templates und Checklisten",
                        "Interaktive Demos",
                        "Real-World Case Studies"
                    ],
                    currency: [
                        "Monatliche Content-Updates",
                        "Zeitstempel für letzte Aktualisierung",
                        "Trending Topics Integration"
                    ],
                    targetScore: "85+",
                    overallStrategy: "Fokus auf E-E-A-T (Experience, Expertise, Authority, Trust) mit datengetriebenen, interaktiven Inhalten"
                } : null,
                competitors: skipWebsite ? [] : [
                    {
                        url: "marktführer-beispiel.de",
                        citationScore: 92,
                        position: 1,
                        strengths: ["Umfassende Guides", "Tägliche Updates", "Expertenteam"],
                        weaknesses: ["Zu technisch für Einsteiger"],
                        authoritySignals: ["10+ Jahre Erfahrung", "Universitäts-Zitate"],
                        comparison: "Deutlich mehr Autorität und Tiefe"
                    },
                    {
                        url: "fachportal-beispiel.de",
                        citationScore: 78,
                        position: 2,
                        strengths: ["Gute Struktur", "Viele Beispiele"],
                        weaknesses: ["Wenig interaktive Elemente"],
                        authoritySignals: ["Branchenverband-Mitglied"],
                        comparison: "Ähnliches Level, aber bessere Struktur"
                    },
                    {
                        url: "info-portal.de",
                        citationScore: 71,
                        position: 3,
                        strengths: ["Aktuelle News", "Newsletter"],
                        weaknesses: ["Oberflächlich"],
                        authoritySignals: ["Pressezitate"],
                        comparison: "Mehr Aktualität, weniger Tiefe"
                    }
                ],
                fanOut: {
                    categories: [
                        {
                            name: `Technische ${keyword} Anforderungen`,
                            icon: "🔧",
                            queries: [
                                {
                                    text: `Welche technischen Voraussetzungen braucht ${keyword}?`,
                                    citationScore: generateQueryScore(),
                                    reasoning: "Grundlegende technische Infos vorhanden, aber fehlende Tiefe"
                                },
                                {
                                    text: `API-Integration für ${keyword} Systeme?`,
                                    citationScore: generateQueryScore() - 10,
                                    reasoning: "Kaum technische Dokumentation verfügbar"
                                },
                                {
                                    text: `Performance-Optimierung bei ${keyword}?`,
                                    citationScore: generateQueryScore(),
                                    reasoning: "Einige Best Practices erwähnt, aber nicht umfassend"
                                },
                                {
                                    text: `Skalierbarkeit von ${keyword} für Enterprise?`,
                                    citationScore: generateQueryScore() - 15,
                                    reasoning: "Enterprise-Content fehlt komplett"
                                }
                            ]
                        },
                        {
                            name: `${keyword} Kosten & ROI`,
                            icon: "💰",
                            queries: [
                                {
                                    text: `TCO-Berechnung für ${keyword} über 3 Jahre?`,
                                    citationScore: generateQueryScore() + 10,
                                    reasoning: "Gute Kostenübersicht vorhanden"
                                },
                                {
                                    text: `Hidden Costs bei ${keyword} Implementation?`,
                                    citationScore: generateQueryScore(),
                                    reasoning: "Teilweise abgedeckt, könnte detaillierter sein"
                                },
                                {
                                    text: `Break-Even-Point für ${keyword} Investment?`,
                                    citationScore: generateQueryScore() - 5,
                                    reasoning: "ROI-Analyse fehlt"
                                },
                                {
                                    text: `Förderungen für ${keyword} in Deutschland?`,
                                    citationScore: generateQueryScore() - 20,
                                    reasoning: "Keine lokalen Informationen"
                                }
                            ]
                        },
                        {
                            name: `${keyword} Best Practices`,
                            icon: "📚",
                            queries: [
                                {
                                    text: `Häufige Fehler bei ${keyword} vermeiden?`,
                                    citationScore: generateQueryScore() + 15,
                                    reasoning: "Gute Fehleranalyse vorhanden"
                                },
                                {
                                    text: `${keyword} Implementierung Schritt-für-Schritt?`,
                                    citationScore: generateQueryScore(),
                                    reasoning: "Basis-Guide vorhanden, aber nicht detailliert"
                                },
                                {
                                    text: `${keyword} Erfolgsmetriken und KPIs?`,
                                    citationScore: generateQueryScore() - 10,
                                    reasoning: "KPI-Framework fehlt"
                                }
                            ]
                        }
                    ]
                },
                gaps: [
                    {
                        category: "Praktische Entscheidungshilfen",
                        title: `Interaktiver ${keyword} Konfigurator`,
                        description: `Tool zur personalisierten ${keyword}-Lösung basierend auf individuellen Anforderungen`,
                        whyExists: "Hoher Entwicklungsaufwand, komplexe Datenintegration",
                        contentType: "Interaktives Web-Tool",
                        opportunity: 5,
                        difficulty: "Hoch",
                        impact: "Sehr hoch",
                        searchVolume: "Hoch"
                    },
                    {
                        category: "Vergleichende Analysen",
                        title: `${keyword} Anbieter-Vergleich`,
                        description: `Detaillierter Vergleich aller relevanten Anbieter`,
                        whyExists: "Aufwändige Recherche nötig",
                        contentType: "Vergleichstabelle",
                        opportunity: 4,
                        difficulty: "Mittel",
                        impact: "Hoch",
                        searchVolume: "Mittel"
                    },
                    {
                        category: "Technisches Spezialwissen",
                        title: `${keyword} API Dokumentation`,
                        description: `Technische Integration und Entwickler-Ressourcen`,
                        whyExists: "Erfordert tiefes technisches Know-how",
                        contentType: "Technische Dokumentation",
                        opportunity: 3,
                        difficulty: "Hoch",
                        impact: "Mittel",
                        searchVolume: "Niedrig"
                    }
                ],
                recommendations: [
                    {
                        priority: 1,
                        title: `${keyword} Knowledge Center aufbauen`,
                        description: "Umfassendes Informationsportal mit interaktiven Tools und Experteninhalten",
                        impact: "Citation Score +30-40 Punkte",
                        actions: [
                            "Content-Audit durchführen",
                            "Experteninterviews planen",
                            "Interaktive Tools entwickeln"
                        ]
                    }
                ]
            };
            
            return result;
        }

        // Display all results
        function displayResults() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultsSection').classList.add('active');
            
            // Display all sections
            displaySummary();
            displayFanOut();
            
            if (!document.getElementById('skipWebsite').checked) {
                displayCompetitors();
            } else {
                displayOptimization();
            }
            
            displayGaps();
            displayRecommendations();
        }

        // Display summary
        function displaySummary() {
            const summaryContent = document.getElementById('summaryContent');
            const summary = analysisResults.summary;
            
            let scoreHtml = '';
            let potentialDisplay = '';
            
            if (summary.citationScore !== null) {
                const score = summary.citationScore;
                const position = analysisResults.websiteAnalysis?.position || null;
                const scoreClass = score >= 70 ? 'score-high' : score >= 50 ? 'score-medium' : 'score-low';
                const strokeColor = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
                
                // Position badge
                let positionBadge = '';
                if (position) {
                    const positionClass = position === 1 ? 'position-high' : 
                                        position <= 3 ? 'position-medium' : 'position-low';
                    positionBadge = `
                        <span class="position-badge ${positionClass}">
                            Position #${position}
                        </span>
                    `;
                }
                
                scoreHtml = `
                    <div class="citation-score-display">
                        <h4>Citation Probability Score ${positionBadge}</h4>
                        <div class="score-circle">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="54" class="score-circle-bg"></circle>
                                <circle cx="60" cy="60" r="54" class="score-circle-fill"
                                    style="stroke: ${strokeColor}; stroke-dasharray: ${score * 3.39} 339; stroke-dashoffset: 0;">
                                </circle>
                            </svg>
                            <div class="score-value" style="color: ${strokeColor}">${score}</div>
                        </div>
                        <p style="margin-top: 10px;">Ihre Website: ${document.getElementById('website').value}</p>
                    </div>
                `;
                
                // Calculate potential score and position
                const potentialIncrease = parseInt(summary.potentialImpact.match(/\d+/g)?.[0] || 35);
                const potentialScore = Math.min(score + potentialIncrease, 100);
                
                // Calculate potential position based on competitors
                let potentialPosition = position;
                if (analysisResults.competitors && analysisResults.competitors.length > 0) {
                    const competitorsAbove = analysisResults.competitors.filter(c => c.citationScore > potentialScore).length;
                    potentialPosition = competitorsAbove + 1;
                }
                
                potentialDisplay = `
                    <div class="potential-score-display">
                        <div class="score-badge">
                            <div class="score-badge-value" style="color: ${strokeColor}">${score}</div>
                            <div class="score-badge-label">Aktuell</div>
                            <div style="font-size: 0.9rem; margin-top: 5px; color: var(--gray);">Position #${position}</div>
                        </div>
                        <div class="score-arrow">→ +${potentialIncrease}</div>
                        <div class="score-badge">
                            <div class="score-badge-value" style="color: var(--success)">${potentialScore}</div>
                            <div class="score-badge-label">Potenzial</div>
                            <div style="font-size: 0.9rem; margin-top: 5px; color: var(--success);">Position #${potentialPosition}</div>
                        </div>
                    </div>
                `;
            }
            
            summaryContent.innerHTML = `
                ${scoreHtml}
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">📊 Top 3 Content Gaps:</h4>
                    <ul style="list-style: none; padding: 0;">
                        ${summary.topGaps.map(gap => `<li style="padding: 8px 0; color: var(--gray);">• ${gap}</li>`).join('')}
                    </ul>
                </div>
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">🎯 Primäre Empfehlung:</h4>
                    <p style="color: var(--gray); line-height: 1.8;">${summary.primaryRecommendation}</p>
                </div>
                ${potentialDisplay}
            `;
        }

        // Display Fan-Out results
        function displayFanOut() {
            const container = document.getElementById('fanOutResults');
            const fanOutData = analysisResults.fanOut;
            
            container.innerHTML = '';
            
            fanOutData.categories.forEach(category => {
                const card = document.createElement('div');
                card.className = 'fan-out-card';
                
                // Handle both old format (queries as strings) and new format (queries as objects)
                let queriesHtml = '';
                if (category.queries && category.queries.length > 0) {
                    if (typeof category.queries[0] === 'string') {
                        // Old format - just display as before
                        queriesHtml = `<ul class="fan-out-queries">
                            ${category.queries.map(q => `<li class="query-text">${q}</li>`).join('')}
                        </ul>`;
                    } else {
                        // New format with citation scores
                        queriesHtml = `<div class="fan-out-queries">
                            ${category.queries.map(q => {
                                const score = q.citationScore || Math.floor(Math.random() * 40) + 30;
                                const scoreClass = score >= 70 ? 'query-score-high' : 
                                                 score >= 50 ? 'query-score-medium' : 'query-score-low';
                                return `
                                    <div class="fan-out-query-item">
                                        <div class="query-header">
                                            <div class="query-text">${q.text || q}</div>
                                            <div class="query-score ${scoreClass}">
                                                Score: ${score}
                                            </div>
                                        </div>
                                        ${q.reasoning ? `<div style="margin-top: 8px; padding-left: 20px; font-size: 0.85rem; color: var(--gray); font-style: italic;">${q.reasoning}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>`;